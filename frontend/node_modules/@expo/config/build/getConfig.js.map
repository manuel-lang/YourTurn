{"version":3,"file":"getConfig.js","sourceRoot":"","sources":["../src/getConfig.ts"],"names":[],"mappings":"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","sourcesContent":["import JsonFile from '@expo/json-file';\nimport { formatExecError } from 'jest-message-util';\nimport path from 'path';\n\nimport { spawnSync } from 'child_process';\nimport { ConfigContext, ExpoConfig } from './Config.types';\nimport { ConfigError, errorFromJSON } from './Errors';\nimport { fileExists } from './Modules';\nimport { serializeAndEvaluate } from './Serialize';\n\n// support all common config types\nexport const allowedConfigFileNames: string[] = (() => {\n  const prefix = 'app';\n  return [\n    // order is important\n    `${prefix}.config.ts`,\n    `${prefix}.config.js`,\n    `${prefix}.config.json`,\n  ];\n})();\n\nfunction isMissingFileCode(code: string): boolean {\n  return ['ENOENT', 'MODULE_NOT_FOUND', 'ENOTDIR'].includes(code);\n}\n\nfunction reduceExpoObject(config?: ExpoConfig): ExpoConfig | null {\n  if (!config) return null;\n\n  if (typeof config.expo === 'object') {\n    // TODO: We should warn users in the future that if there are more values than \"expo\", those values outside of \"expo\" will be omitted in favor of the \"expo\" object.\n    return config.expo as ExpoConfig;\n  }\n  return config;\n}\n\nexport function findAndEvalConfig(request: ConfigContext): ExpoConfig | null {\n  // TODO(Bacon): Support custom config path with `findConfigFile`\n  // TODO(Bacon): Should we support `expo` or `app` field with an object in the `package.json` too?\n\n  function testFileName(configFilePath: string): null | Partial<ExpoConfig> {\n    if (!fileExists(configFilePath)) return null;\n\n    try {\n      return evalConfig(configFilePath, request);\n    } catch (error) {\n      // If the file doesn't exist then we should skip it and continue searching.\n      if (!isMissingFileCode(error.code)) {\n        throw error;\n      }\n    }\n    return null;\n  }\n\n  if (request.configPath) {\n    const config = testFileName(request.configPath);\n    if (config) {\n      return reduceExpoObject(serializeAndEvaluate(config));\n    } else {\n      throw new ConfigError(\n        `Config with custom path ${request.configPath} couldn't be parsed.`,\n        'INVALID_CONFIG'\n      );\n    }\n  }\n\n  for (const configFileName of allowedConfigFileNames) {\n    const configFilePath = path.resolve(request.projectRoot, configFileName);\n    const config = testFileName(configFilePath);\n    if (config) return reduceExpoObject(serializeAndEvaluate(config));\n  }\n\n  return null;\n}\n\n// We cannot use async config resolution right now because Next.js doesn't support async configs.\n// If they don't add support for async Webpack configs then we may need to pull support for Next.js.\nfunction evalConfig(configFile: string, request: ConfigContext): Partial<ExpoConfig> {\n  if (configFile.endsWith('.json')) {\n    return JsonFile.read(configFile, { json5: true });\n  } else {\n    try {\n      const spawnResults = spawnSync(\n        'node',\n        [\n          require.resolve('@expo/config/build/scripts/read-config.js'),\n          '--colors',\n          configFile,\n          JSON.stringify({ ...request, config: serializeAndEvaluate(request.config) }),\n        ],\n        {}\n      );\n\n      if (spawnResults.status === 0) {\n        const spawnResultString = spawnResults.stdout.toString('utf8').trim();\n        const logs = spawnResultString.split('\\n');\n        // Get the last console log to prevent parsing anything logged in the config.\n        const lastLog = logs.pop()!;\n        for (const log of logs) {\n          // Log out the logs from the config\n          console.log(log);\n        }\n        // Parse the final log of the script, it's the serialized config\n        return JSON.parse(lastLog);\n      } else {\n        // Parse the error data and throw it as expected\n        const errorData = JSON.parse(spawnResults.stderr.toString('utf8'));\n        throw errorFromJSON(errorData);\n      }\n    } catch (error) {\n      if (isMissingFileCode(error.code) || !(error instanceof SyntaxError)) {\n        throw error;\n      }\n      const message = formatExecError(\n        error,\n        { rootDir: request.projectRoot, testMatch: [] },\n        { noStackTrace: true },\n        undefined,\n        true\n      );\n      throw new ConfigError(`\\n${message}`, 'INVALID_CONFIG');\n    }\n  }\n}\n"]}